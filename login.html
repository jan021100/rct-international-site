<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Login — RCT International</title>
  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode:'class',
      theme:{ extend:{
        colors:{
          base:{50:'#F6F5F2',900:'#0D0D0F'},
          neutral:{800:'#1f2328',700:'#2B2B2E',600:'#4b5563',500:'#64748b',300:'#cbd5e1'},
          gold:'#D6B25E', accent:'#D36B1F'
        },
        fontFamily:{sans:['Inter','system-ui','sans-serif'], serif:['Playfair Display','serif']},
        boxShadow:{soft:'0 10px 30px rgba(0,0,0,.08)'}
      }}
    }
  </script>
  <style>
    .anim{transition:all .2s ease}
    /* (Optional) Debug console styles; safe if elements not present */
    #debug-wrap{position:sticky; bottom:0; z-index:50}
    #debug-log{max-height:220px; overflow:auto; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    .badge{border:1px solid rgb(203 213 225 / .6); border-radius:9999px; padding:.125rem .5rem; font-size:.75rem}
  </style>
</head>
<body class="bg-base-50 text-neutral-800 dark:bg-base-900 dark:text-neutral-200">
  <!-- Header -->
  <div id="site-header"></div>

  <!-- Hero -->
  <section class="py-10 text-center">
    <div class="max-w-3xl mx-auto px-4">
      <h1 class="font-serif text-4xl text-neutral-900 dark:text-base-50">Sign in to RCT</h1>
      <p class="mt-3 opacity-90">Use your email and password to sign in. New here? Create an account.</p>
    </div>
  </section>

  <!-- Auth card -->
  <section class="pb-12">
    <div class="max-w-4xl mx-auto px-4">
      <div class="rounded-2xl border border-neutral-300/60 dark:border-neutral-700 bg-white dark:bg-neutral-950 shadow-soft">
        <div class="grid grid-cols-2 text-sm font-medium">
          <button id="tab-signin" class="py-3 border-b-2 border-neutral-900 dark:border-base-50">Sign in</button>
          <button id="tab-create" class="py-3 border-b-2 border-transparent hover:border-neutral-300 dark:hover:border-neutral-700 anim">Create account</button>
        </div>
        <div class="p-6">
          <!-- Sign in -->
          <form id="form-signin" class="space-y-4">
            <div>
              <label class="block text-sm mb-1">Email</label>
              <input id="si-email" type="email" required class="w-full px-4 py-2 rounded-lg border dark:bg-neutral-900">
            </div>
            <div>
              <label class="block text-sm mb-1">Password</label>
              <input id="si-password" type="password" required minlength="6" class="w-full px-4 py-2 rounded-lg border dark:bg-neutral-900">
            </div>
            <div class="flex items-center gap-3">
              <button type="submit" class="px-4 py-2 rounded-lg bg-neutral-900 text-white dark:bg-base-50 dark:text-neutral-900">Sign in</button>
              <button type="button" id="btn-forgot" class="text-sm underline">Forgot password</button>
            </div>
            <p id="si-msg" class="text-sm mt-2"></p>
          </form>

          <!-- Create -->
          <form id="form-create" class="space-y-4 hidden">
            <div class="grid sm:grid-cols-2 gap-4">
              <div class="sm:col-span-2">
                <label class="block text-sm mb-1">Full name</label>
                <input id="ca-name" type="text" required class="w-full px-4 py-2 rounded-lg border dark:bg-neutral-900">
              </div>
              <div>
                <label class="block text-sm mb-1">Email</label>
                <input id="ca-email" type="email" required class="w-full px-4 py-2 rounded-lg border dark:bg-neutral-900">
              </div>
              <div>
                <label class="block text-sm mb-1">Password</label>
                <input id="ca-password" type="password" required minlength="6" class="w-full px-4 py-2 rounded-lg border dark:bg-neutral-900">
              </div>
            </div>
            <div class="text-sm">
              <label class="flex items-start gap-2">
                <input id="ca-terms" type="checkbox" required class="mt-1">
                <span>I agree to the <a href="/terms.html" class="underline">Terms and Code of Conduct</a>.</span>
              </label>
            </div>
            <button type="submit" class="px-4 py-2 rounded-lg bg-neutral-900 text-white dark:bg-base-50 dark:text-neutral-900">Create account</button>
            <p id="ca-msg" class="text-sm mt-2"></p>
          </form>
        </div>
      </div>

      <!-- Signed-in status -->
      <div id="signed-in-card" class="hidden mt-6 p-6 rounded-2xl border bg-white dark:bg-neutral-950 shadow-soft">
        <h3 class="font-semibold">You are signed in</h3>
        <p id="user-line" class="text-sm opacity-80 mt-1"></p>
        <div id="role-line" class="text-sm opacity-80"></div>
        <div class="mt-4 flex gap-2">
          <a href="account.html" class="px-4 py-2 rounded-lg border">Open account</a>
          <button id="btn-logout" class="px-4 py-2 rounded-lg bg-neutral-900 text-white dark:bg-base-50 dark:text-neutral-900">Sign out</button>
        </div>
      </div>
    </div>
  </section>

  <!-- (Optional) Debug console block goes here if you want it; code below is safe even when it’s missing. -->

  <div id="site-footer"></div>

  <!-- Components loader + sticky header offset -->
  <script defer>
    async function loadComponent(id, file) {
      const host = document.getElementById(id);
      if (!host) return;
      const res = await fetch(file, { cache: 'no-cache' });
      host.innerHTML = await res.text();
    }
    function applyHeaderOffset() {
      const header = document.getElementById('main-header');
      document.body.style.paddingTop = header ? header.offsetHeight + 'px' : '0px';
    }
    (async () => {
      await Promise.all([
        loadComponent('site-header','/components/header.html'),
        loadComponent('site-footer','/components/footer.html')
      ]);
      const header = document.getElementById('main-header');
      if (header) {
        applyHeaderOffset();
        const ro = new ResizeObserver(applyHeaderOffset);
        ro.observe(header);
        if (document.fonts && document.fonts.ready) document.fonts.ready.then(applyHeaderOffset);
        window.addEventListener('resize', applyHeaderOffset);
        window.addEventListener('orientationchange', applyHeaderOffset);
      }
    })();
  </script>

  <!-- App logic (safe without debug console) -->
  <script type="module">
  import { auth, db, rctSignIn, rctSignOut, onUserChanged, getUserProfile } from '/assets/js/firebase.js';
  import {
    onAuthStateChanged, sendPasswordResetEmail, getIdTokenResult,
    createUserWithEmailAndPassword, updateProfile
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ===== Tiny logger (safe, no UI deps) =====
  const log = {
    info: (...a)=>console.log('[login]', ...a),
    warn: (...a)=>console.warn('[login]', ...a),
    error:(...a)=>console.error('[login]', ...a)
  };

  // ===== Redirect helper =====
  function gotoAccount() {
    const next = new URLSearchParams(location.search).get('next') || 'account.html';
    location.replace(next);
  }

  // ===== Tabs =====
  const tabs = { signin: document.getElementById('tab-signin'), create: document.getElementById('tab-create') };
  const forms = { signin: document.getElementById('form-signin'), create: document.getElementById('form-create') };
  function show(panel){
    Object.values(tabs).forEach(b=>b.classList.remove('border-neutral-900','dark:border-base-50'));
    tabs[panel].classList.add('border-neutral-900','dark:border-base-50');
    Object.values(forms).forEach(f=>f.classList.add('hidden'));
    forms[panel].classList.remove('hidden');
    ['si-msg','ca-msg'].forEach(id=>{
      const el=document.getElementById(id);
      if(el){ el.textContent=''; el.classList.remove('text-red-600','text-green-700'); }
    });
  }
  tabs.signin.addEventListener('click',()=>show('signin'));
  tabs.create.addEventListener('click',()=>show('create'));
  show('signin');

  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const ok  = (elm,msg)=>{ elm.textContent=msg; elm.classList.remove('text-red-600'); elm.classList.add('text-green-700'); };
  const err = (elm,msg)=>{ elm.textContent=msg; elm.classList.remove('text-green-700'); elm.classList.add('text-red-600'); };

  // ===== Signed-in status card =====
  const signedCard = document.getElementById('signed-in-card');
  const userLine   = document.getElementById('user-line');
  const roleLine   = document.getElementById('role-line');
  async function showSignedIn(user){
    if(!user){ signedCard.classList.add('hidden'); return; }
    userLine.textContent = `Signed in as ${user.email}`;
    try {
      const profile = await getUserProfile(user.uid);
      const r = (profile && profile.roles) || {};
      roleLine.textContent = (profile && profile.roles)
        ? `Roles: ${r.spolekMember ? 'CZ spolek member' : '—'} | ${r.evMember ? 'DE e.V. member' : '—'}`
        : '';
      signedCard.classList.remove('hidden');
    } catch (e) {
      roleLine.textContent = '';
      signedCard.classList.remove('hidden');
      log.warn('getUserProfile failed (non-fatal)', e?.message);
    }
  }

  // ===== IMPORTANT: prevent early redirects during signup =====
  let creatingAccount = false;

  // Global auth observer: update context only; DO NOT redirect here
  onAuthStateChanged(auth, async (user)=>{
    log.info('onAuthStateChanged', { uid:user?.uid || null });
    if (user) {
      // If this was a background sign-in while creating account, let the create flow handle redirect.
      if (creatingAccount) { return; }
      // Show “you are signed in” card; let explicit actions (submit) navigate.
      showSignedIn(user);
      try { await getIdTokenResult(user, true); } catch {}
    } else {
      showSignedIn(null);
    }
  });

  // Also avoid redirecting from your custom observer
  onUserChanged(user => {
    log.info('onUserChanged', { uid:user?.uid || null });
    if (creatingAccount) return;
    // Do not auto-redirect from here; just update the card
    if (user) showSignedIn(user); else showSignedIn(null);
  });

  // ===== Firestore profile create =====
  async function createUserDoc(uid, { name, email }) {
    log.info('createUserDoc → setDoc', { uid });
    await setDoc(
      doc(db, 'users', uid),
      {
        name: name || '',
        email: email || '',
        roles: { spolekMember:false, evMember:false, rctMember:true, admin:false },
        createdAt: new Date().toISOString()
      },
      { merge: true }
    );
    // Optional: verify write
    try {
      const snap = await getDoc(doc(db,'users', uid));
      log.info('createUserDoc verify exists:', snap.exists());
    } catch {}
  }

  // ===== Sign in =====
  forms.signin.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = $('#si-email').value.trim();
    const pw    = $('#si-password').value;
    const msg = document.getElementById('si-msg'); msg.textContent='Signing in...';
    try {
      await rctSignIn(email,pw);
      ok(msg,'Signed in. Redirecting…');
      gotoAccount();
    } catch(e){
      err(msg, e.message || 'Sign-in failed.');
      log.error('Sign-in failed', e);
    }
  });

  // ===== Forgot password =====
  document.getElementById('btn-forgot').addEventListener('click', async ()=>{
    const email = $('#si-email').value.trim();
    const msg = document.getElementById('si-msg');
    if(!email) return err(msg,'Enter your email first.');
    try { await sendPasswordResetEmail(auth,email); ok(msg,'Password reset email sent.'); }
    catch(e){ err(msg,'Could not send email.'); log.error('Password reset failed', e); }
  });

  // ===== Create account (Auth → Firestore → Redirect) =====
  forms.create.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name  = $('#ca-name').value.trim();
    const email = $('#ca-email').value.trim();
    const pw    = $('#ca-password').value;
    const msg = document.getElementById('ca-msg'); msg.textContent='Creating account…';

    creatingAccount = true;
    try {
      // 1) Create in Auth
      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      const user = cred.user;
      if (name) {
        try { await updateProfile(user, { displayName: name }); } catch {}
      }

      // 2) Create/merge Firestore profile (allowed by your rules for own uid)
      try {
        await createUserDoc(user.uid, { name, email });
      } catch (w) {
        err(msg, (w && w.message) || 'Could not create profile. Please retry.');
        creatingAccount = false;
        return;
      }

      // 3) Done → redirect
      ok(msg,'Account created. Redirecting…');
      gotoAccount();

    } catch(e){
      err(msg, e.message || 'Could not create account.');
      log.error('Create-account failed', e);
      creatingAccount = false;
    }
  });

  // ===== Sign out (if you show the signed-in card on this page) =====
  document.getElementById('btn-logout')?.addEventListener('click', async ()=>{
    await rctSignOut();
  });
</script>
</body>
</html>